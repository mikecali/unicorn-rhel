
- name: verify if repo is available
  become: yes
  command: "rpm -qa | grep mysql57-community"
  register: verify

- name: Add the repository
  become: yes
  command: rpm -ivh 'https://dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm'
  when: verify|failed

- name: Install mysql
  yum: pkg={{ item }} state=installed
  become: true
  with_items:    
    - mariadb-server
    - mysql-connector-python
  when: "'{{ db }}' in inventory_hostname"

- name: Ensure mysql started
  become: yes
  service: name=mysqld state=started enabled=yes
  when: "'{{ db }}' in inventory_hostname"

- name: Install MySQL-Python for Ansible to talk to MySQL
  yum: pkg=MySQL-python state=installed 

- name: Update MySQL root password for all root accounts
  mysql_user: check_implicit_admin=yes
              login_user=root
              login_password={{ mysql_root_password }}
              user=root
              password={{ NEW_mysql_root_password }}
              host={{ item }}
              priv='*.*:ALL,GRANT'

  with_items:
    - 127.0.0.1
    - ::1
    - localhost
  when: "'{{ db }}' in inventory_hostname"

- name: Ensure mysql started
  become: yes
  service: name=mysqld state=started enabled=yes
  when: "'{{ db }}' in inventory_hostname"


  